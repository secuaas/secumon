---
apiVersion: v1
kind: ConfigMap
metadata:
  name: secumon-migrations
  namespace: secumon
data:
  migrations.sql: |
$(cat /tmp/all-migrations.sql | sed 's/^/    /')

---
apiVersion: batch/v1
kind: Job
metadata:
  name: secumon-migrations
  namespace: secumon
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: migrate
        image: postgres:16-alpine
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for database to be ready..."
          until pg_isready -h timescaledb -U postgres; do
            sleep 2
          done
          echo "Running migrations..."
          psql postgresql://metrics_writer:metrics_prod_pass_2026@timescaledb:5432/metrics -f /migrations/migrations.sql
          echo "Migrations completed!"
        volumeMounts:
        - name: migrations
          mountPath: /migrations
      volumes:
      - name: migrations
        configMap:
          name: secumon-migrations
